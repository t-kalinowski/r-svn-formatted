#
# ${RHOME}/Makefile

VPATH = @srcdir@
srcdir = @srcdir@
top_srcdir = @top_srcdir@

top_builddir = .

include $(top_builddir)/Makeconf

base_src = `ls $(top_srcdir)/src/*/*.[chf] \
	       $(top_srcdir)/src/library/*/R/*.R`

all: R docs

R: stamp-R
stamp-R: $(top_builddir)/src/include/Platform.h $(base_src)
	@for d in afm doc etc src; do cd $$d; $(MAKE) R; cd ..; done
	@if [ ! -f src/library/stamp-docs ]; then \
	  echo "You should \`make docs' now ..."; \
	fi
	@touch $@

$(top_builddir)/src/include/Platform.h: $(srcdir)/date-stamp
	$(top_srcdir)/configure --srcdir $(top_srcdir)

$(base_src):

docs help html latex dvi:: FORCE
	-@cd src/library; $(MAKE) $@

FORCE:

install: all installdirs
	$(INSTALL_DATA) $(srcdir)/R.1 $(mandir)/man1
	$(INSTALL_DATA) $(srcdir)/Rdconv.1 $(mandir)/man1
	(cd $(mandir)/man1; \
		for f in Rd2txt.1 Rdindex.1 Sd2Rd.1; \
			do rm -f $$f; $(LN_S) Rdconv.1 $$f; \
		done)
	@(cd $(srcdir); \
	  for f in COPYING COPYRIGHTS MIRROR-SITES RESOURCES; do \
	    $(INSTALL_DATA) $$f $(rhome); \
	  done)
	cd afm; $(MAKE) $@
	$(INSTALL_PROGRAM) bin/R.binary $(rhome)/bin
	cat bin/R | sed "s@RHOME=.*@RHOME=$(rhome)@" > $(rhome)/bin/R
	cat bin/R | sed "s@RHOME=.*@RHOME=$(rhome)@" > $(bindir)/R
	chmod 755 $(bindir)/R $(rhome)/bin
	@for f in `ls bin/* | grep -v '^R\|R.binary'`; do \
	  $(INSTALL) $$f $(rhome)/bin; \
	done
	@for f in Rd2txt Rdconv Rdindex Sd2Rd; do \
	  $(INSTALL) bin/$$f $(bindir); \
	done
	cd demos; $(MAKE) $@
	cd doc; $(MAKE) $@
	cd etc; $(MAKE) $@
	@for f in include/*.h; do \
	  $(INSTALL_DATA) $$f $(rhome)/include; \
	done
	@echo "Installing library ..."
	cd library; tar cf - [a-z]* | (cd $(rhome)/library; tar xf -)
	(cd $(rhome)/library; cat */TITLE > LibIndex 2> /dev/null)
	$(rhome)/bin/build-help --rhome $(rhome) --htmllists

installdirs:
	@$(MKINSTALLDIRS) $(bindir)
	@$(MKINSTALLDIRS) $(mandir)/man1
	@$(MKINSTALLDIRS) $(rhome)/bin
	@$(MKINSTALLDIRS) $(rhome)/etc
	@$(MKINSTALLDIRS) $(rhome)/include
	@$(MKINSTALLDIRS) $(rhome)/library

install-strip:
	$(MAKE) INSTALL_PROGRAM="${INSTALL_PROGRAM} -s" install

uninstall:

mostlyclean: clean
clean:
	@for d in afm doc etc src; do \
	  cd $$d; $(MAKE) $@; cd ..; \
	done
	@rm -f stamp-R
distclean: clean
	@for d in afm demos doc etc src; do \
	  cd $$d; $(MAKE) $@; cd ..; \
	done
	@rm -rf bin/* include/* library/*
	@rm -f Makeconf Makefile Makefile.bak Makefrag.f77 \
	  config.cache config.log config.status
maintainer-clean: distclean

dist:

info:

TAGS:

check test:: test-Examples

test-All test-Examples::
	-@cd tests; $(MAKE) $@
