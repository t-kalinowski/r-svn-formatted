#! @PERL@
#-*- perl -*-
#
# ${RHOME}/etc/build-index
# Usage:  build-index [pkg] [lib]

use File::Basename;
use Cwd;

$cwd=getcwd();
if($ENV{"RHOME"}){
    $RHOME=$ENV{"RHOME"};
}
else{
    chdir(dirname($0) . "/..");
    $RHOME=getcwd();
}
chdir($cwd);

require "$RHOME/etc/buildlib.pl";

($pkg, $lib) = buildinit();

$dest = "$lib/$pkg";

system("mkdir -p $dest");
die("Cannot create $dest\n") unless (-d "$dest");

system("/bin/cp TITLE $dest/TITLE");
open title, "<TITLE";
$title = <title>;
close title;
$title =~ s/^\S*\s*(.*)/$1/;

system("mkdir -p $dest/help");
die("Cannot create $dest/help\n") unless (-d "$dest/help");
system("mkdir -p $dest/html");
die("Cannot create $dest/html\n") unless (-d "$dest/html");

chdir "man" or die("There are no man pages in $pkg\n");
opendir man, '.';
@mandir = readdir(man);

$anindex = "$lib/$pkg/help/AnIndex";
open(anindex, ">${anindex}.in");

foreach $manfile (@mandir) {
    if($manfile =~ /\.Rd$/){
	$manfilebase = basename($manfile, ".Rd");

	if(!($pkg =~ /^base$/)){
	    print anindex "$manfilebase\t$manfilebase\n";
	}
	
	open(aliases, "grep '^\\\\alias' $manfile |");
	while(<aliases>){
	    /\\alias\{(.*)\}/;
	    $alias = $1;
	    $alias =~ s/\\%/%/g;
	    print anindex "$alias\t$manfilebase\n";
	}
	close aliases;
    }
}

close anindex;

system("sort -f -d ${anindex}.in | uniq > ${anindex}");
unlink ("$anindex.in");


### Build the local index.html file

open(anindex, "<$anindex");
open(htmlfile, ">$lib/$pkg/html/00Index.html");

print htmlfile "<HEAD><TITLE>R Function Index: $pkg</TITLE></HEAD>\n";
print htmlfile "<BODY LINK=#0000EF VLINK=#0000EF>\n";
print htmlfile "[ <A HREF =\"../../../html/index.html\">top</A> | \n";
print htmlfile "<A HREF =\"../../index.html\">up</A> ]\n";
print htmlfile "<HR ALIGN=middle>\n";
print htmlfile "<H2><CENTER>";
print htmlfile $title;
print htmlfile "</CENTER></H2>\n";
print htmlfile "<HR ALIGN=middle>\n";
print htmlfile "<CENTER><TABLE>\n";
print htmlfile "<TR ALIGN=LEFT>\n";

$k = 0;

while(<anindex>){
    ($alias, $file) = split;
    print htmlfile "<TD><A HREF=\"$file.html\">$alias</A>\n";
    $k++;
    if($k == 5) {
	print htmlfile "<TR>\n";
	$k=0;
    }
}

print htmlfile "</TABLE></CENTER>\n";
print htmlfile "</BODY>\n";

close htmlfile;
close anindex;


build_htmlpkglist($lib);
    
