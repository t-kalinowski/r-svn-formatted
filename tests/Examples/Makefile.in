#
# ${RHOME}/tests/Examples/Makefile

VPATH = @srcdir@
srcdir = @srcdir@
top_srcdir = @top_srcdir@

top_builddir = ../..

include $(top_builddir)/Makeconf

CleanMe = .RData sink-examp.txt

R = $(top_builddir)/bin/R --no-init-file --no-save --no-restore --vsize 6
Rbase = $(top_builddir)/library/base
Rbinary = $(top_builddir)/bin/R.binary

Rd_BASEDIR = $(top_srcdir)/src/library/base/man
EXAMPLES = $(shell cd $(Rd_BASEDIR); ls *.Rd | sed 's/Rd$$/R/g')

##- Uncomment one of the 2 'Rd_files' defs -- depending on your 'make' version
##--- <<<<<< CONFIGURE should do this >>>>>>
##-- Sun make
# Rd_files:sh = ../../etc/Rd.files
##-- GNU make
# Rd_files := $(shell $(rRHOME)/etc/Rd.files)
#this has PATH prepended: Rd_files := $(wildcard $(MANbaseDIR)/*.Rd)
#________in future_______  (for ALL 'make' versions)
# FAILS: has directory/. _AND_ is not expanded
#Rd_files = $(MANbaseDIR)/*.Rd
#
#R_src = $(Rd_files:%.Rd=%.R)
#________in future_______: (FAILS!)
#R_src = $(Rd_files:$(MANbaseDIR)/%.Rd=%.R)


##--------------------------------- TARGETS ------------------------------

all: test-Examples

test-Examples: All-Ex.Rout

All-Ex.Rout: All-Ex.R
	@if [ -f $@.bak ]; then mv $@.bak $@.bakk ; fi
	@if [ -f $@ ]; then mv $@ $@.bak ; fi
	@echo "Running all help() examples ..."
	$(R) < $< > $@

All-Ex.R: $(EXAMPLES)
	@if [ -f $@.bak ]; then mv $@.bak $@.bakk ; fi
	@if [ -f $@ ]; then mv $@ $@.bak ; fi
	@echo "Massaging examples into $@ ..."
	@-$(srcdir)/massage-Examples $(EXAMPLES) > $@

%.R: $(Rd_BASEDIR)/%.Rd
	@RHOME=`cd $(top_builddir); pwd`; export RHOME; \
	   $${RHOME}/bin/Rdconv -t example $< > $@
	@-echo $@

##-- The `show-*' are just for testing purposes:
show-R:
	@-echo "R = \`$(R)'"
show-Rd:
	@-echo "Rd files [sources of help() files]:"
	@-echo $(Rd_FILES)
show-Ex:
	@-echo "Examples [targets of help() files]:"
	@-echo $(EXAMPLES)

mostlyclean: clean
clean:
	@rm -f *.Rd* *.ps *.tex *.dat* data foo*
distclean: clean
	@rm -f *.R $(CleanMe) Makefile
maintainer-clean: distclean
