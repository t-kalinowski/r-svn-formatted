#
# ${R_HOME}/tests/Makefile

VPATH = @srcdir@
srcdir = @srcdir@
top_srcdir = @top_srcdir@

top_builddir = ..
subdir = tests

include $(top_builddir)/Makeconf

SUBDIRS = Examples

R = LC_ALL=C $(top_builddir)/bin/R --vanilla

TESTsrc = simple-true.R arith-true.R arith.R d-p-q-r-tests.R \
	 print-tests.R is-things.R primitive-funs.R eval-etc.R
TESTout = $(TESTsrc:.R=.Rout)

distdir = $(top_builddir)/$(PACKAGE)-$(VERSION)/$(subdir)
DISTFILES = Makefile.in README Rdiff \
	all-equal.R mode-methods.R $(TESTsrc) \
	$(TESTsrc:.R=.Rout.save)

%.Rout: %.R stamp-R
	@rm -f $@.fail
	@(SRCDIR=$(srcdir); export SRCDIR; \
	  echo "$(R) < $< > $@"; \
	  $(R) < $< > $@)
	@echo -n "Comparing \`$@' to \`$(srcdir)/$@.save' ..."
	@$(srcdir)/Rdiff $@ $(srcdir)/$@.save || \
	  (mv $@ $@.fail && exit 1)
	@echo " OK"

all: Makefile test-All

Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
	cd $(top_builddir) && \
	  CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= \
	  $(SHELL) ./config.status

test-All: Makefile test-Examples test-Specific

test-Examples:
	@cd Examples && $(MAKE) $@
test-Specific: $(TESTout)

stamp-R:: $(top_builddir)/bin/R.X11 $(top_builddir)/library/base/R/base
	@cd $(top_builddir) && $(MAKE) R
	@touch $@

mostlyclean: clean
clean:
	-(cd Examples; $(MAKE) $@)
	rm -f stamp-R
distclean: clean
	@rm -f $(TESTout)
	-(cd Examples; $(MAKE) $@)
	@rm -f Makefile
maintainer-clean: distclean

distdir: $(DISTFILES)
	@for f in $(DISTFILES); do \
	  test -f $(distdir)/$${f} \
	    || ln $(srcdir)/$${f} $(distdir)/$${f} 2>/dev/null \
	    || cp -p $(srcdir)/$${f} $(distdir)/$${f}; \
        done
	@for d in $(SUBDIRS); do \
	  test -d $(distdir)/$${d} \
	    || mkdir $(distdir)/$${d} \
	    || exit 1; \
	  chmod 755 $(distdir)/$${d}; \
	  (cd $${d} && $(MAKE) distdir) \
	    || exit 1; \
        done
